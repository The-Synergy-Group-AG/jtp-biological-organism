FROM python:3.12-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Set pip configuration for better reliability
RUN pip config set global.index-url https://pypi.org/simple/ && \
    pip config set global.trusted-host pypi.org

# Create a basic dependencies layer for better caching
RUN pip install --no-cache-dir --upgrade pip wheel setuptools

# Install lightweight dependencies first (for faster caching)
RUN pip install --no-cache-dir \
    fastapi==0.115.6 \
    uvicorn[standard]==0.32.1 \
    pydantic==2.10.3 \
    pydantic-settings==2.7.1 \
    openai==1.57.4 \
    anthropic==0.40.0 \
    requests==2.32.3 \
    httpx==0.28.1 \
    websockets==14.1 \
    redis==5.2.1

# Install second layer of dependencies
RUN pip install --no-cache-dir \
    scikit-learn==1.6.1 \
    pandas==2.2.3 \
    numpy==1.26.4 \
    motor==3.7.0 \
    pymongo==4.10.1 \
    python-jose[cryptography]==3.3.0 \
    passlib[bcrypt]==1.7.4 \
    python-multipart==0.0.9 \
    oauthlib==3.2.2 \
    requests-oauthlib==2.0.0

# Install third layer - larger packages
RUN pip install --no-cache-dir \
    PyPDF2==3.0.1 \
    python-docx==1.1.2 \
    reportlab==4.2.5 \
    pdfkit==1.0.0 \
    email-validator==2.2.0 \
    sendgrid==6.12.0 \
    twilio==9.4.4 \
    babel==2.16.0 \
    langdetect==1.0.9 \
    jinja2==3.1.5 \
    aiofiles==24.1.0 \
    prometheus-client==0.21.1 \
    structlog==24.2.0

# Install testing and development dependencies
RUN pip install --no-cache-dir \
    pytest==8.3.4 \
    pytest-asyncio==0.25.2 \
    black==24.10.0 \
    isort==5.13.2 \
    flake8==7.1.1 \
    deap==1.4.1 \
    optuna==4.1.0

# Install remaining packages
RUN pip install --no-cache-dir \
    beautifulsoup4==4.12.3 \
    lxml==5.3.0 \
    python-dateutil==2.9.0.post0 \
    pytz==2024.2 \
    click==8.1.8 \
    rich==13.9.4 \
    PyYAML==6.0.2 \
    toml==0.10.2

# Install heavy ML dependencies with version compatibility
RUN pip install --no-cache-dir --retries 10 --timeout 300 \
    torch==2.9.0 --index-url https://download.pytorch.org/whl/cpu && \
    pip install --no-cache-dir --retries 10 --timeout 300 \
    transformers==4.47.0 \
    sentence-transformers==3.3.1

# Copy requirements and install any custom dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir --retries 10 --timeout 300 -r requirements.txt

# Copy application code
COPY src/ ./src/
COPY docs/ ./docs/
COPY consciousness_state/ ./consciousness_state/

# Create checkpoints directory if it doesn't exist
RUN mkdir -p checkpoints

EXPOSE 8001 8002 8003 8004 8005

# Create health check script
RUN printf '#!/usr/bin/env python3\nimport sys\nimport socket\ntry:\n    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\n    sock.settimeout(5)\n    result = sock.connect_ex(("127.0.0.1", 8001))\n    sock.close()\n    sys.exit(0 if result == 0 else 1)\nexcept:\n    sys.exit(1)' > /usr/local/bin/health_check.py && chmod +x /usr/local/bin/health_check.py

# Basic health check - just check if port is open
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD python /usr/local/bin/health_check.py

# Simple startup command
CMD ["uvicorn", "src.cns-consciousness-core.main:app", "--host", "0.0.0.0", "--port", "8001", "--reload"]
